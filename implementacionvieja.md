import { NextResponse } from "next/server";import { MercadoPagoConfig, Preference } from 'mercadopago';if (!process.env.MERCADOPAGO_ACCESS_TOKEN) {  throw new Error('MERCADOPAGO_ACCESS_TOKEN must be defined');}const client = new MercadoPagoConfig({   accessToken: process.env.MERCADOPAGO_ACCESS_TOKEN});export async function POST(req: Request) {  try {    const {       licensePlate,      fee,      vehicleType,      paymentType // 'regular' o 'qr'    } = await req.json();    console.log('Creating preference with data:', { licensePlate, fee, vehicleType, paymentType });    // Crear la preferencia de pago    const preferenceData = {      body: {        items: [          {            id: licensePlate,            title: `Estacionamiento - ${vehicleType} - ${licensePlate}`,            unit_price: Number(fee),            quantity: 1,            currency_id: "ARS"          }        ],        back_urls: {          success: `${process.env.NEXT_PUBLIC_BASE_URL}/payment/success`,          failure: `${process.env.NEXT_PUBLIC_BASE_URL}/payment/failure`,          pending: `${process.env.NEXT_PUBLIC_BASE_URL}/payment/pending`        },        notification_url: `${process.env.NEXT_PUBLIC_BASE_URL}/api/payment/webhook`,        auto_return: "approved",        statement_descriptor: "Parking System",        external_reference: licensePlate,        payment_methods: paymentType === 'qr' ? {          excluded_payment_types: [            { id: "credit_card" },            { id: "debit_card" },            { id: "bank_transfer" }          ],          default_payment_method_id: "account_money"        } : undefined      }    };    console.log('Preference data:', preferenceData);    const preference_client = new Preference(client);    const response = await preference_client.create(preferenceData);    console.log('Mercado Pago response:', response);    if (paymentType === 'qr') {      // Para pagos QR, generamos un QR que apunte directamente al punto de pago      const qrData = response.init_point;      return NextResponse.json({        id: response.id,        init_point: response.init_point,        qr_code: qrData      });    }    return NextResponse.json({      id: response.id,      init_point: response.init_point    });  } catch (error) {    console.error("Error detallado de Mercado Pago:", error);    return NextResponse.json(      { error: "Error al procesar el pago", details: error },      { status: 500 }    );  }} 
Collapse file: app/payment/failure/page.tsx‎app/payment/failure/page.tsx‎Copy file name to clipboard+18Lines changed: 18 additions & 0 deletionsOriginal file line numberDiff line numberDiff line change@@ -0,0 +1,18 @@import { Button } from "@/components/ui/button";import Link from "next/link";export default function PaymentFailurePage() {  return (    <div className="flex flex-col items-center justify-center min-h-screen bg-background">      <div className="text-center space-y-4">        <h1 className="text-4xl font-bold text-red-600">Error en el Pago</h1>        <p className="text-xl text-muted-foreground">          Hubo un problema al procesar tu pago. Por favor, intenta nuevamente.        </p>        <Button asChild>          <Link href="/">Volver al inicio</Link>        </Button>      </div>    </div>  );} 
Collapse file: app/payment/pending/page.tsx‎app/payment/pending/page.tsx‎Copy file name to clipboard+18Lines changed: 18 additions & 0 deletionsOriginal file line numberDiff line numberDiff line change@@ -0,0 +1,18 @@import { Button } from "@/components/ui/button";import Link from "next/link";export default function PaymentPendingPage() {  return (    <div className="flex flex-col items-center justify-center min-h-screen bg-background">      <div className="text-center space-y-4">        <h1 className="text-4xl font-bold text-yellow-600">Pago Pendiente</h1>        <p className="text-xl text-muted-foreground">          Tu pago está siendo procesado. Te notificaremos cuando se complete.        </p>        <Button asChild>          <Link href="/">Volver al inicio</Link>        </Button>      </div>    </div>  );} 
Collapse file: app/payment/success/page.tsx‎app/payment/success/page.tsx‎Copy file name to clipboard+18Lines changed: 18 additions & 0 deletionsOriginal file line numberDiff line numberDiff line change@@ -0,0 +1,18 @@import { Button } from "@/components/ui/button";import Link from "next/link";export default function PaymentSuccessPage() {  return (    <div className="flex flex-col items-center justify-center min-h-screen bg-background">      <div className="text-center space-y-4">        <h1 className="text-4xl font-bold text-green-600">¡Pago Exitoso!</h1>        <p className="text-xl text-muted-foreground">          Tu pago ha sido procesado correctamente.        </p>        <Button asChild>          <Link href="/">Volver al inicio</Link>        </Button>      </div>    </div>  );} 
Collapse file: components/admin-panel.tsx‎components/admin-panel.tsx‎Copy file name to clipboardExpand all lines: components/admin-panel.tsx+161-196Lines changed: 161 additions & 196 deletions Load DiffLarge diffs are not rendered by default.
Collapse file: components/icons.tsx‎components/icons.tsx‎Copy file name to clipboard+13Lines changed: 13 additions & 0 deletionsOriginal file line numberDiff line numberDiff line change@@ -0,0 +1,13 @@import {  CreditCard,  Banknote,  QrCode,  Building2} from "lucide-react";export const Icons = {  creditCard: CreditCard,  cash: Banknote,  qrCode: QrCode,  bank: Building2,}; 
Collapse file: components/operator-panel.tsx‎components/operator-panel.tsx‎Copy file name to clipboardExpand all lines: components/operator-panel.tsx+50-33Lines changed: 50 additions & 33 deletionsOriginal file line numberDiff line numberDiff line change@@ -44,8 +44,9 @@ export default function OperatorPanel({  setExitInfo,}: OperatorPanelProps) {  const [licensePlate, setLicensePlate] = useState("")  const [vehicleType, setVehicleType] = useState<VehicleType | "">("")  const [selectedType, setSelectedType] = useState<VehicleType>("Auto")  const [error, setError] = useState("")  const [processingExit, setProcessingExit] = useState<string | null>(null)  const handleEntrySubmit = (e: React.FormEvent) => {    e.preventDefault()@@ -56,7 +57,7 @@ export default function OperatorPanel({      return    }    if (!vehicleType) {    if (!selectedType) {      setError("Debe seleccionar un tipo de vehículo")      return    }@@ -66,26 +67,35 @@ export default function OperatorPanel({      return    }    if (availableSpaces[vehicleType as VehicleType] <= 0) {      setError(`No hay espacios disponibles para ${vehicleType}`)    if (availableSpaces[selectedType] <= 0) {      setError(`No hay espacios disponibles para ${selectedType}`)      return    }    onRegisterEntry({      licensePlate,      type: vehicleType as VehicleType,      type: selectedType,    })    setLicensePlate("")    setVehicleType("")    setSelectedType("Auto")  }  const handleExit = async (licensePlate: string) => {    await onRegisterExit(licensePlate);  }  const handleExit = async (vehicle: Vehicle) => {    if (processingExit === vehicle.licensePlate) return;    try {      setProcessingExit(vehicle.licensePlate);      await onRegisterExit(vehicle.licensePlate);      // Actualizar la lista de vehículos estacionados localmente      const updatedVehicles = parking.parkedVehicles.filter(v => v.licensePlate !== vehicle.licensePlate);      parking.parkedVehicles = updatedVehicles;    } finally {      setProcessingExit(null);    }  };  return (    <div className="space-y-6">    <div className="space-y-8">      {/* Disponibilidad */}      <Card>        <CardHeader>@@ -141,8 +151,8 @@ export default function OperatorPanel({              <div className="space-y-2">                <Label htmlFor="vehicleType">Tipo de Vehículo</Label>                <Select                  value={vehicleType}                  onValueChange={(value: string) => setVehicleType(value as VehicleType)}                  value={selectedType}                  onValueChange={(value: string) => setSelectedType(value as VehicleType)}                >                  <SelectTrigger id="vehicleType">                    <SelectValue placeholder="Seleccionar tipo" />@@ -206,33 +216,40 @@ export default function OperatorPanel({          {parking.parkedVehicles.length === 0 ? (            <p className="text-center text-gray-500 py-4">No hay vehículos estacionados actualmente</p>          ) : (            <div className="overflow-x-auto">            <div className="border rounded-lg">              <table className="w-full">                <thead>                  <tr className="border-b">                    <th className="text-left py-2 px-2">Matrícula</th>                    <th className="text-left py-2 px-2">Tipo</th>                    <th className="text-left py-2 px-2">Hora de Entrada</th>                    <th className="text-left py-2 px-2">Acción</th>                    <th className="text-left p-2">Matrícula</th>                    <th className="text-left p-2">Tipo</th>                    <th className="text-left p-2">Hora de Entrada</th>                    <th className="text-left p-2">Acción</th>                  </tr>                </thead>                <tbody>                  {parking.parkedVehicles.map((vehicle) => (                    <tr key={vehicle.licensePlate} className="border-b">                      <td className="py-2 px-2">{vehicle.licensePlate}</td>                      <td className="py-2 px-2">{vehicle.type}</td>                      <td className="py-2 px-2">{formatTime(vehicle.entryTime)}</td>                      <td className="py-2 px-2">                        <Button                          variant="destructive"                          size="sm"                          onClick={() => handleExit(vehicle.licensePlate)}                        >                          Registrar Salida                        </Button>                      </td>                    </tr>                  ))}                  {parking.parkedVehicles                    .filter((vehicle, index, self) =>                       index === self.findIndex(v => v.licensePlate === vehicle.licensePlate)                    )                    .map((vehicle) => (                      <tr                         key={`${vehicle.licensePlate}-${vehicle.entryTime.getTime()}`}                         className="border-b"                      >                        <td className="p-2">{vehicle.licensePlate}</td>                        <td className="p-2">{vehicle.type}</td>                        <td className="p-2">{formatTime(vehicle.entryTime)}</td>                        <td className="p-2">                          <Button                            variant="destructive"                            onClick={() => handleExit(vehicle)}                            disabled={processingExit === vehicle.licensePlate}                          >                            {processingExit === vehicle.licensePlate ? 'Procesando...' : 'Registrar Salida'}                          </Button>                        </td>                      </tr>                    ))}                </tbody>              </table>            </div>
Collapse file: components/parking-app.tsx‎components/parking-app.tsx‎Copy file name to clipboardExpand all lines: components/parking-app.tsx+108-3Lines changed: 108 additions & 3 deletionsOriginal file line numberDiff line numberDiff line change@@ -108,11 +108,116 @@ export default function ParkingApp() {        case 'transferencia':          alert("Por favor, realiza la transferencia a la siguiente cuenta:\n\nBanco: XXX\nCBU: XXXXXXXXXXXXX\nAlias: XXXXX");          break;        case 'link':          window.open(`https://tu-link-de-pago.com/parking-exit`, '_blank');        case 'mercadopago':          try {            const mpResponse = await fetch("/api/payment/mercadopago", {              method: "POST",              headers: {                "Content-Type": "application/json",              },              body: JSON.stringify({                licensePlate: exitingVehicle.licensePlate,                fee: fee,                vehicleType: exitingVehicle.type,                paymentType: 'regular'              }),            });            if (!mpResponse.ok) {              throw new Error("Error al generar el pago con Mercado Pago");            }            const { init_point } = await mpResponse.json();            window.open(init_point, '_blank');          } catch (error) {            console.error("Error con Mercado Pago:", error);            alert("Error al procesar el pago con Mercado Pago");            return;          }          break;        case 'qr':          alert("Función de QR en desarrollo");          try {            const mpResponse = await fetch("/api/payment/mercadopago", {              method: "POST",              headers: {                "Content-Type": "application/json",              },              body: JSON.stringify({                licensePlate: exitingVehicle.licensePlate,                fee: fee,                vehicleType: exitingVehicle.type,                paymentType: 'qr'              }),            });            if (!mpResponse.ok) {              const errorData = await mpResponse.json();              console.error("Error de Mercado Pago:", errorData);              throw new Error(errorData.error || "Error al generar el QR de Mercado Pago");            }            const { qr_code, init_point } = await mpResponse.json();            if (qr_code || init_point) {              const qrWindow = window.open('', '_blank');              if (qrWindow) {                qrWindow.document.write(`                  <html>                    <head>                      <title>Código QR para pago</title>                      <style>                        body {                          display: flex;                          flex-direction: column;                          align-items: center;                          justify-content: center;                          min-height: 100vh;                          margin: 0;                          font-family: Arial, sans-serif;                          background-color: #f5f5f5;                        }                        .container {                          text-align: center;                          padding: 20px;                          background-color: white;                          border-radius: 10px;                          box-shadow: 0 2px 10px rgba(0,0,0,0.1);                        }                        h1 {                          color: #333;                          margin-bottom: 20px;                        }                        .amount {                          font-size: 24px;                          color: #2563eb;                          margin-bottom: 20px;                        }                        img {                          max-width: 300px;                          margin-bottom: 20px;                        }                      </style>                    </head>                    <body>                      <div class="container">                        <h1>Escanea el código QR para pagar</h1>                        <div class="amount">Monto a pagar: $${fee.toFixed(2)}</div>                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qr_code || init_point)}" alt="QR Code"/>                        <p>Abre Mercado Pago en tu celular y escanea este código</p>                      </div>                    </body>                  </html>                `);              } else {                alert("No se pudo abrir la ventana del QR. Por favor, habilita las ventanas emergentes.");              }            } else {              throw new Error("No se pudo generar el código QR");            }          } catch (error) {            console.error("Error al generar QR:", error);            alert(error instanceof Error ? error.message : "Error al generar el código QR para el pago");            return;          }          break;      }
Collapse file: components/payment-method-dialog.tsx‎components/payment-method-dialog.tsx‎Copy file name to clipboardExpand all lines: components/payment-method-dialog.tsx+18-28Lines changed: 18 additions & 28 deletionsOriginal file line numberDiff line numberDiff line change@@ -3,11 +3,10 @@ import {  Dialog,  DialogContent,  DialogDescription,  DialogFooter,  DialogHeader,  DialogTitle,} from "@/components/ui/dialog";import { CreditCard, Banknote, Link, QrCode } from "lucide-react";import { CreditCard, Banknote, QrCode, Building2 } from "lucide-react";interface PaymentMethodDialogProps {  open: boolean;@@ -24,56 +23,47 @@ export function PaymentMethodDialog({}: PaymentMethodDialogProps) {  return (    <Dialog open={open} onOpenChange={onOpenChange}>      <DialogContent className="sm:max-w-[425px]">      <DialogContent className="sm:max-w-md">        <DialogHeader>          <DialogTitle>¿Cómo deseas realizar el pago?</DialogTitle>          <DialogTitle>Seleccionar método de pago</DialogTitle>          <DialogDescription>            Selecciona el método de pago para completar la operación. Monto a pagar: ${fee}            Total a pagar: ${fee.toFixed(2)}          </DialogDescription>        </DialogHeader>        <div className="grid grid-cols-2 gap-4 py-4">        <div className="flex flex-col gap-4">          <Button            variant="outline"            className="flex flex-col items-center gap-2 h-auto py-4"            className="w-full justify-start"            onClick={() => onSelectMethod("efectivo")}          >            <Banknote className="h-6 w-6" />            <span>Efectivo</span>            <span className="text-xs text-muted-foreground">Pago en efectivo</span>            <Banknote className="mr-2 h-4 w-4" />            Efectivo          </Button>          <Button            variant="outline"            className="flex flex-col items-center gap-2 h-auto py-4"            className="w-full justify-start"            onClick={() => onSelectMethod("transferencia")}          >            <CreditCard className="h-6 w-6" />            <span>Transferencia</span>            <span className="text-xs text-muted-foreground">Transferencia bancaria</span>            <Building2 className="mr-2 h-4 w-4" />            Transferencia Bancaria          </Button>          <Button            variant="outline"            className="flex flex-col items-center gap-2 h-auto py-4"            onClick={() => onSelectMethod("link")}            className="w-full justify-start"            onClick={() => onSelectMethod("mercadopago")}          >            <Link className="h-6 w-6" />            <span>Link de Pago</span>            <span className="text-xs text-muted-foreground">Pago online</span>            <CreditCard className="mr-2 h-4 w-4" />            Mercado Pago          </Button>          <Button            variant="outline"            className="flex flex-col items-center gap-2 h-auto py-4"            className="w-full justify-start"            onClick={() => onSelectMethod("qr")}          >            <QrCode className="h-6 w-6" />            <span>QR</span>            <span className="text-xs text-muted-foreground">Escanear código QR</span>            <QrCode className="mr-2 h-4 w-4" />            Código QR          </Button>        </div>        <DialogFooter>          <Button variant="secondary" onClick={() => onOpenChange(false)}>            Cancelar          </Button>        </DialogFooter>      </DialogContent>    </Dialog>  );